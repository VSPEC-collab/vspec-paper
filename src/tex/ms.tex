% Define document class
\documentclass[twocolumn]{aastex631}
\usepackage{showyourwork}


\newcommand{\teff}{$T_{\rm eff}$}
\definecolor{tedcommentcolor}{HTML}{e17701}
\newcommand{\TJ}[1]{\textcolor{tedcommentcolor}{#1}}

\shorttitle{\sc VSPEC}
\shortauthors{Johnson et al.}

% Begin!
\begin{document}

% Title
\title{The {\sc VSPEC} code: Spectroscopic phase curves of 3D exoplanet models in the presence of stellar variability}

\author{Ted Johnson}
\affiliation{NASA Goddard Space Flight Center \\
8800 Greenbelt Rd \\
Greenbelt, MD 20771, USA}
\affiliation{Nevada Center for Astrophysics, University of Nevada, Las Vegas, 4505 South Maryland Parkway, Las Vegas, NV 89154, USA}
\affiliation{Department of Physics and Astronomy, University of Nevada, Las Vegas, 4505 South Maryland Parkway, Las Vegas, NV 89154, USA}
% Also CRESST, SURA, SEEC!

\author{Cameron Kelahan}
\affiliation{NASA Goddard Space Flight Center \\
8800 Greenbelt Rd \\
Greenbelt, MD 20771, USA}

\author{Avi M. Mandell}
\affiliation{NASA Goddard Space Flight Center \\
8800 Greenbelt Rd \\
Greenbelt, MD 20771, USA}

\author{Tom Barclay}
\affiliation{NASA Goddard Space Flight Center \\
8800 Greenbelt Rd \\
Greenbelt, MD 20771, USA}

\author{Veselin B. Kostov}
\affiliation{NASA Goddard Space Flight Center \\
8800 Greenbelt Rd \\
Greenbelt, MD 20771, USA}

\author{Geronimo L. Villanueva}
\affiliation{NASA Goddard Space Flight Center \\
8800 Greenbelt Rd \\
Greenbelt, MD 20771, USA}

% Abstract with filler text
\begin{abstract}
    We present the Variable Star Phase Curve (\href{https://github.com/VSPEC-collab/VSPEC}{ \sc VSPEC}) code,
    a python package to simulate spectroscopic observations of rocky exoplanets in the presence of stellar variability.
    {\sc VSPEC} uses the Planetary Spectrum Generator's Global Emission Spectra (PSG GlobES) application along with a custom-built
    stellar model to produce spectroscopic light curves of the planet-host system. We also describe associated codes. \TJ{These codes should be named here and described a little}
\end{abstract}

\keywords{Exoplanet, M dwarf}

% Main body with filler text
\section{Introduction}
\label{sec:intro}

In the era of high-sensitivity exoplanet characterization missions such as the James Webb Space Telescope (JWST)
and the Atmospheric Remote-sensing Infrared Exoplanet Large-survey (ARIEL), spectral analysis of exoplanet atmospheres
is increasingly sensitive to contamination due to stellar inhomogenies (spots, granulation, etc.).

Recent analysis of the JWST/NIRSpec transit of GJ 486b by \citet{moran2023} exposed a degeneracy between
atmospheric absorption by water and water-rich spots on the stellar surface. This ``transit light source effect''
\citep[TLS,][see also \citet{apai2018,barclay2021,garcia2022,barclay2023}]{rackham2018}
occurs when the occulted region of the stellar surface is not representitive of the disk-integrated spectrum

Similarly, the Mid-IR Exoplanet CLimate Explorer \citep[MIRECLE,][]{mandell2022} mission concept
will employ the Planetary Infrared Excess \citep[PIE][]{stevenson2020} technique to extract the planetary
contribution from combined-light observations. Uncertainties on the stellar spectrum will dominate the analysis if it is not removed appropriately.

To adequately prepare for future observations and future missions it will be necessary to demonstrate a method to mitigate these effects.
This task requires a flexible tool that combines models of exoplanet atmospheres and stellar variability in a robust way.

We present {\sc VSPEC}: Variable Star PhasE Curve\footnote{\url{https://github.com/VSPEC-collab/VSPEC}},
an open-source Python 3 package to simulate observations of exoplanet systems with variable host stars.
{\sc VSPEC} combines NASA's Planetary Spectrum Generator \citep[PSG,][]{villanueva2018} with a grid of
custom PHOENIX models \citep{husser2013} to produce multiwavelength phase curves of the system, accounting
for a 3D planetary atmosphere, transits and eclipses, and multiple sources of stellar variability.

In this paper we will describe the science behind {\sc VSPEC} and demonstrate examples of its use.
Section \ref{sec:star} describes the stellar model and the available sources of variability.
Section \ref{sec:pl_model} discusses modeling the planetary atmosphere, including PSG/GlobES and the
built-in GCM. In Section \ref{sec:examples} we provide examples of {\sc VSPEC} use cases and demonstrate
its value to the exoplanet community. Finally, in Section \ref{sec:conclusion} we will discuss the future of the code and issues it might have.


{Stellar Model \label{sec:star}}

The {\sc VSPEC} star model is designed modularly to allow
for both simple and complex behaviors. Currently, it
is represented by a rectangular grid of points on the stellar surface,
each assigned an effective temperature. At any given time, the model computes
the surface coverage fractions of each temperature visible to the observer, accounting for the
spherical geometry, limb darkening, and any occultation by a transiting planet.

The attributes of the \texttt{Star} class describe the bulk properties of the star, including radius,
period, and the effective temperature of quiet photosphere. Herein we refer to this temperature as the
photosphere temperature to differentiate it from the temperature of spots, faculae, or other sources of variability.

\begin{figure}
    \centering
        \includegraphics[width=0.5\textwidth]{figures/surface_map_and_lc.pdf}
    \script{surface_map_and_lc.py}
    \caption{{\bf Top}: The surface map of a star with spots and faculae during a transit.
    The large circles are spots. Faculae display their 3D structure, as the hot wall is more prevalent near the limbs.
    {\bf Bottom}: An example lightcurve of a spotted star.}
    \label{fig:surface_map}
\end{figure}

\subsection{Stellar Spectra \label{subsec:spectra}}
Once the surface coverage is calculated, a composite spectrum is computed from a grid of PHOENIX stellar spectra
\citep{husser2013} As of \texttt{VSPEC 0.1}, we have spectra between 2300 K and 3900 K, with steps of
100 K. Each spectrum has $\log{g} = 5$ and solar metalicity.
The raw spectra span from 0.1 to 20 \micron~ with $5 \times 10^{-6}$ \micron~ steps, however binned
versions are pre-computed for faster runtimes.

\subsection{Spots \label{subsec:spots}}
Our star spot model is nearly entirely based on observations of the sun. Sun spots can be resolved and are well-studied,
whereas spots on other stars (e.g., M dwarfs) can only be observed indirectly. We therefore designed our spot model to mimic
sun spots but with parameterized values for spot temperature and lifetime that can be matched to observations of other stellar types and ages.


On the Sun, spots have two regions: the dark, central umbra and the lighter, surrounding penumbra. A detailed review of sunspot behavior,
including sizes and lifetimes, is \citet{solanki2003}, however the specific solar values are not relevant to this description. However,
the spot area as a function of time is
\begin{equation}
    A(t) = \left\{
    \begin{array}{lr}
        A_0 e^{(t-t_0)/\tau}, & \text{if } t \leq t_0 \\
        A_0 - W(t-t_0), & \text{if } t > t_0
    \end{array}
    \right\}
\end{equation}
where $A_0$ is the maximum area reached, $t_0$ is the time of the maximum, $\tau$ is the exponential growth rate, and $W$ is the linear decay rate.

{\sc VSPEC} also takes in parameters describing the population of spots, such as the mean of the (lognormal) peak area distribution
\citep{bogdan1988}, the equilibrium surface coverage, and the distribution style.

\subsection{Faculae \label{subsec:faculae}}
Faculae are magnetically-generated regions of the solar surface that usually appear as bright points near the limb; we employ the ``hot wall''
model \citep{spruit1976} where faculae are described as three-dimensional pores in the stellar surface with a hot, bright wall, and a
cool, dark floor, as shown in Figure \ref{fig:fac_struct}.

Their three-dimensional structure causes faculae to behave differently depending on their angle from disk-center. Close to the limb,
the hot wall is visible to the observer, and faculae appear as bright points. Near the center, however, the cool floor is exposed and
faculae appear dark. To consider this effect in the faculae lightcurve, we compute the fraction of the facula's normalized area -- the
area on the disk it would occupy as a flat spot -- that is occupied by each the hot wall and cool floor. This is done via numerical integral
along the radius of the spot.

\begin{equation}
    f_{wall} = \frac{\int _{-R}^{R} Z_{\rm eff} dr}{\int _{-R}^{R} Z_{\rm eff} dr + \int _{-R}^{R} R_{\rm eff} dr}
\end{equation}
where $Z_{\rm eff}$ is the apparent height of the wall
\begin{equation}
    Z_{\rm eff} = \left\{
    \begin{array}{lr}
        Z_w \sin{\alpha}, & \text{if } \alpha \leq \alpha_{\rm crit} \\
        2\sqrt{R^2 - r^2}\cos{\alpha}, & \text{if } \alpha > \alpha_{\rm crit}
    \end{array}
    \right\}
\end{equation}
and $R_{\rm eff}$ is the apparent width of the floor
\begin{equation}
    R_{\rm eff} = \left\{
    \begin{array}{lr}
        2\sqrt{R^2 - r^2} - Z_w\sin{\alpha}, & \text{if } \alpha \leq \alpha_{\rm crit} \\
        0, & \text{if } \alpha > \alpha_{\rm crit}
    \end{array}
    \right\}
\end{equation}
for facula radius $R$, depth $Z_w$, and angle from disk-center $\alpha$. $r$ in this numerical scheme
is defined as the distance from the center of the facula along the radial line connecting the facula center to the
disk center. $\alpha_{\rm crit}$ is the value of alpha at which the floor is no longer visible and is defined to be $\arctan{\frac{2\sqrt{R^2-r^2}}{Z_w}}$.

According to \citet{1997ApJ...484..479T}, faculae temperatures (of both the floor and wall) are dependent on the facula radius,
while depth appears to be constant. They also find that the smallest faculae have no visible floor, and that even at disk center they
appear as bright points. We parameterize the floor temperature to be
\begin{equation}
    \Delta T_{\rm eff, floor} = \left\{
    \begin{array}{lr}
    \text{Not visible}, & \text{if } r<r_{\rm min} \\
    m_{\rm floor}(r-r_{\rm min}) + \Delta T_{\rm eff, floor, 0}, & \text{if } r \ge r_{\rm min}
    \end{array}
    \right\}
\end{equation}

Where $r$ is the radius of the facula, $r_{\rm min}$ is the minimum radius where the floor is visible, $\Delta  T_{\rm eff, floor, 0}$ is
the difference between the floor and photosphere \teff at $r_{\rm min}$, and $m_{\rm floor}$ is the slope of the relationship with
units of [temperature] [length]$^{-1}$.

Similarly, the wall temperature is parameterized

\begin{equation}
    \Delta T_{\rm eff,wall} = m_{\rm wall}r + \Delta T_{\rm eff,wall,0}
\end{equation}

Where $\Delta T_{\rm eff,wall,0}$ is the temperature of a zero-radius facula and and $m_{\rm wall}$ is the slope of the radius-temperature
relationship with units of [temperature] [length]$^{-1}$.
These relationships can be defined by the user, for example setting $m=0$ for constant temperatures.

Facula lifetimes are defined as the time it takes to decay by $e^{-2}$. Because faculae grow and decay exponentially
at the same rate, each facula spends 1 lifetime with a radius greater than $e^{-1}$ of it's maximum. Each facula is born
and dies at $e^{-2}$ of its maximum, effectively existing in the code for two lifetimes.

\citet{hovis-afflerbach2022} suggest a typical facula lifetime to be on the order of 6 hours,
with a distribution that resembles a Poisson function. However, we choose a lognormal distribution
for both lifetime and maximum radius because it does not allow for these values to be 0. We choose to
correlate lifetime and radius so that they are determined by the normally distributed random variable $\mu$;
for each new facula, $\mu$ is randomly drawn and determines both the faclue lifetime and maximum radius.

\begin{figure}
    \centering
    \gridline{\includegraphics[width=0.5\textwidth]{figures/facula_model.png}}
    \gridline{\includegraphics[width=0.5\textwidth]{figures/facula_depth.pdf}}
    \script{facula_depth.py}
    \caption{
        ``Hot Wall'' model of faculae. Faculae structure causes their contrast to be dependent on their distance
        from the center of the disk. {\bf Top}: Depiction of a facula on the limb of a star. The hot wall is exposed
        to the observer causing the pore to appear bright. At disk center, the cool floor is most visible. {\bf Bottom}:
        The effects of depression depth and viewing angle on facula brightness. The 3D structure of faculae is most apparent
        when radius $\sim$ depth. A toy flux model was used to demonstrate the shape of these curves, but their magnitudes
        in practice depend on stellar spectral models.
        }
    \label{fig:fac_struct}
\end{figure}

\subsection{Flares \label{subsec:flares}}
Flares are an important source of stellar variability on short timescales. We use the {\sc xoflares}
package \citep{barclay2020} to generate realistic lightcurve shapes and assume a blackbody spectrum.
{\sc xoflares} uses a flare profile function empirically derived by \citet{davenport2016} to
describe a flare lightcurve. Temperature, $E$, FWHM, and the peak time together completely describe a flare's multiwavelength lightcurve.

Before simulating an observation, {\sc VSPEC} pre-computes a population of flares based on the frequency-energy relationship from \citet{gao2022}:
\begin{equation} \label{eq:flare_freq}
    \log{(f{\rm [day]})} = \beta + \alpha~\log{(E/{\rm [erg]})}
\end{equation}

Where $f$ is the frequency of flares with energies $\ge E$.
We compute the number of expected flares over a time duration and determine the number to create $N$ by a random Poisson draw.
We then generate $N$ flares with energies determined by the quantile function:
\begin{equation}
    E = E_{\text{min}} (1-X)^{1/\alpha}
\end{equation}

where $E_{\text{min}}$ is the minimum considered flare energy and $X$ is a random number on the interval $[0,1)$.
We set the default values $\alpha=-0.829$, $\beta=26.87$ from \citet{gao2022}. Figure \ref{fig:flare_freq}
shows our simulation results compared to their powerlaw.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{figures/flare_freq.pdf}
    \caption{
        {\bf Top}: Generated flare frequencies compared to those expected from \citet{gao2022}, generated using a 10,000 day simulation.
        The $y$-axis shows the frequency of flares with energies {\em greater than or equal to} the value of the $x$-axis. Error bars
        based on the square root of the number of observed flares as this is a Poisson process.
        {\bf Bottom}: Lightcurve of a star flaring with the same powerlaw slope as the top panel, but the intercept ($\beta$) has been increased by 0.3
        for visual effect. The mean flare temperature is $9000$ K and the mean FWHM is $3$ hours.
        }
    \script{flare_freq.py}
    \label{fig:flare_freq}
\end{figure}

\subsection{Granulation}
Granulation is a source of stellar variability that arises from convection near the surface of the star.
The result is a stellar surface that is not constant in temperature and that changes on very short timescales.
Hydrodynamic simulations of stellar atmospheres \citep[e.g.][]{magic2014} describe hot granules of rising gas surrounded by cooler,
sinking regions with a \teff a few percent lower than the nominal value.

We model granulation as a global process, and its effects are computed after the effects of spots and faculae.
Of the remaining ``quiet'' photosphere (i.e. the regions not covered in spots of faculae), a fraction is computed to be part of the cool
inter-granule surface. The surface coverage of the cool region at any given time is computed by a Gaussian process (GP) using
the \sc{tinygp} package \citep{foreman-mackey2024} following the methodology of \citet{gordon2020}.
The GP uses a custom kernel function based on a power spectrum \citep{anderson1990,kallinger2014} to produce random changes in the coverage.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{figures/granulation_lightcurve.pdf}
    \caption{
        Effect of granulation on the lightcurve of a star. This simulation assumes a mean
        10\% coverage by inter-granule region whose temperature is 300 K lower than the surrounding photosphere.
        It also assumes that the coverage value varies with a magnitude of 1\% on a timescale of 6 hours.
        }
    \script{granule_lc.py}
    \label{fig:gran_lc}
a\end{figure}

\section{Planet Model \label{sec:pl_model}}
Our model uses the Planetary Spectrum Generator\footnote{\href{https://psg.gsfc.nasa.gov/}{https://psg.gsfc.nasa.gov/}}
\citep[PSG,][]{villanueva2018} to calculate the planetary spectrum. We upload a 3D Global Circulation Model (GCM) to PSG's
Global Emission Spectra (GlobES) application to retrieve thermal and reflected spectra for various points in the planet's phase curve. \TJ{cite Vincent's paper}

\subsection{Interfacing through {\sc pypsg}}
\ref{subsec:pypsg}
{\sc VSPEC} interfaces with PSG using the {\sc pypsg} package \TJ{link}, which is essentially a Python wrapper for the PSG API system.

\TJ{Write much more}

\subsection{3D Planet models}
{\sc VSPEC} allows the user to upload any desired GCM. However, for questions that focus on detectability,
the specific physics of the GCM are less important than properties like day/night temperature, surface pressure, or
the major absorbers in the atmosphere. To simplify these studies, {\sc VSPEC} has a built-in GCM that takes in just a
few parameters and produces a simple-yet-robust exoplanet climate. Simplicity allows the user to know everything about
the model and reduce surprises, but its basis in thermodynamics and robust energy balance make this model fit for publication-level science \TJ{is this really true? probably not}.

The {\sc VSPEC} GCM centers around a 2D temperature map of the planet's surface. Based on \citet{cowan2011}, this map
is constructed completely given the incident flux from the star (parameterized by the host \teff and radius
and the planet's semimajor axis and Bond albedo) and the unitless thermal redistribution efficiency $\epsilon$.
This efficiency is 0 for a planet that reradiates instantly and $\gg 1$ for an atmosphere that efficiently redistributes heat to its night side.
Figure \ref{fig:thermal_inertia} shows a temperature map example for an Earth-like planet with $\epsilon = 2\pi$.
These temperature maps are validated by the energy balance of the planet; {\sc VSPEC} computes the incident and emergent
flux across the planet and asserts that they agree.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{figures/cowan_gcm.pdf}
    \caption{
        Example of a surface temperature map created by {\sc VSPEC}. The solar flux at Earth,
        a Bond albedo of 0.3, and $\epsilon = 2\pi$ were used in this case.
        Notice that the hottest point is offset from the sub-stellar point due to thermal inertia.
    }
    \script{cowan_gcm.py}
    \label{fig:thermal_inertia}
\end{figure}

Now that we have the surface temperature at each GCM coordinate we can build the atmosphere on top of it.
We choose a surface pressure for our model and generate a pressure profile as a function of layer. It is
important to note that the choice of the pressure profile -- provided it is scaled to the surface pressure and sampled in a reasonable manner -- is
arbitrary and will not affect the spectrum of the planet. This is because PSG calculates the altitude and thickness of each layer based on the
pressure and surface gravity; the pressure profile is essentially a proxy for the sampling of atmosphere layers as a function of altitude.

Next we create an adiabatic temperature profile at each GCM coordinate. An adiabat assumes that
\begin{equation}
    T^\gamma P^{1 - \gamma} = \text{const.}
\end{equation}
where $\gamma$ is the adiabatic index. Therefore the temperature profile can be computed
\begin{equation}
    T = T_{\rm surf} \left(\frac{P}{P_{\rm surf}} \right)^{1 - \frac{1}{\gamma} }
\end{equation}

Finally, we populate our atmosphere with molecules. The user specifies the species and abundance and atmosphere is filled accordingly with a constant molecular suite.

The caveats of this approach lie in the simplified physics of the atmosphere structure. The heat-redistribution model does not
capture the effects of latitudinal mixing; an adiabatic temperature profile will never exhibit the temperature inversion
that we know form in complex atmospheres like Earth's. Similarly, setting a constant abundance does not allow for water vapor to
vary with temperature as it does on Earth. We must also be careful not to add so much of an absorbing species that the energy balance of
the atmosphere would change; instead we treat them as trace species in an otherwise transparent atmosphere. Our simplified approach
allows us to easily examine a large parameter space of atmospheres whose behaviors are easy to predict.




\bibliography{syw,VSPEC}

\end{document}
